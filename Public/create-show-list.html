<!DOCTYPE html>

<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="../Style.css">
    <title></title>
</head>

<body>

    <div  class="container">
        <!------ nav ------>   
        <ul class="navbar">
            <li class="navbarElem"><a class="active">Hjem</a></li>
            <li class="navbarElem"><a onclick="displayCreateListTemp()">Ny liste</a></li>
            <li class="navbarElem"><a onclick="displayShowListTemp()" >Mine lister</a></li>
            <li class="navbarElem"><a onclick="openModal1()">Profil</a></li>
            <li class="navbarElem"><a onclick="openModal2()">Logg ut</a></li>
            <li class="navbarElem"><span id="numTxt1" class="nav-bar-txt">Ingen lister</span></li>
            <li class="nav-bar-txt"><span id="userTxt"></span></li>
        </ul>  
        
        <div id="container"></div>
      
    </div>
    
<!---------------------- Forside --------------------->
    
    <template id="frontPageTemp">
        
        <!-------------- Meny -------------> 
        
        <!--<ul class="navbar">
            <li class="nav-bar-txt"><span id="userTxt1"></span></li>
        </ul> -->
        
        <h1> OVERSIKT </h1>
    
       <div class="menuChoice" onclick="displayCreateListTemp()">
            <h3>NY LISTE</h3>
            <p class="ptag">Hei</p>
            <img src="../img/new-list-icon.png" class="icons">
        </div>
        
        <div class="menuChoice" onclick="displayShowListTemp()">
            <h3>MINE LISTER</h3>
            <p id="numTxt2" class="ptag">Ingen lister</p>
            <img src="../img/list-icon.png" class="icons">
        </div>
        
        <div class="menuChoice">
            <h3>KALENDER</h3>
            <p>Ingen avtaler eller tidspunkter</p>
            <img src="../img/calender.icon.png" class="icons">
        </div>
        
        <div class="menuChoice" onclick="openModal1()">
            <h3>PROFIL</h3>
            <p class="ptag">Hei</p>
            <img src="../img/profile-icon.png" class="icons">
        </div>
        
    </template>
    
<!---------------------- lag ny liste ---------------------> 
    
    <template id="createListTemp">
        
        <div id="create-list-div">
            <h3>Lag ny liste</h3>    

            <input class="inpField" placeholder="Listenavn" id="nameInp">
            <button id="btnDone" class="buttons" onclick="addListToDb()">Ferdig!</button><br><br> 
            
            <div id="listNameCont"></div>
          
        </div>
    </template>
    
<!---------------------- legg til posts ---------------------> 
    
    <template id="addPostToList">
        <h3 id="listNameHeader"></h3>   
        <input id="elemInp" class="inpField" placeholder="Hva skal gjøres" type="text"><br>
        <button id="btnAddPost" class="buttons" onclick="addPostsToDb()">Legg til</button><br><br>
        <div id="contCreateList"></div> 
    </template>
    
<!---------------------- vis lister ---------------------> 
    
    <template id="showListTemp">
                
        <h3 id="titleTxt" style="color: #f76f6f;">Mine lister</h3>
        <hr>
        <div class="row">
            <div id="contLister" class="column"></div>            
            <hr> 
            <div id="contDone" class="column"></div> 
        </div>
    </template>

<!---------------------- profil modal ---------------------> 
    
    <div id="profileModal" class="modal">

        <div class="modal-content">
            <span id="close" onclick="closeModal()" >&times;</span>
            <p><img src="../img/profile-icon-red-border.png" class="icons"></p>
            <h3 id="profName" style="margin-top: -66px;">Navn</h3>
            <p id="profUName" class="ptag">Brukernavn</p>
            <p id="profEmail" class="ptag">Epost</p>
            <button class="buttons gray-buttons">Bytt passord</button>
        </div>

    </div>
    
<!---------------------- logg ut modal ---------------------> 
    
    <div id="logoutModal" class="modal">
        <div class="modal-content">
            <h3 >Ha det, vi sees!</h3><br>
            <button class="buttons gray-buttons" onclick="logout()">Ok!</button>
        </div>
    </div>
    
</body>
    
<script>
    
    //For å vise hvr mange lister en bruker har: SELECT COUNT(ProductID) FROM Products;
    
    const DEBUG = true;
    var authenticationToken = null;
    var authenticatedUser = null;
    let dataUserName = localStorage.getItem("userName");
    let dataUserId = localStorage.getItem("id");
    //let dataListId = 
    
    let cont = document.getElementById("container");    
    let currentList = [];
    let listeData = []; //slett etterhvert
    displayfrontPageTemp();
    
    function displayfrontPageTemp(){
        viewTemp("frontPageTemp", cont);
    }   
    
/*----------------- Create a new  list ------------------- */
    
    function displayCreateListTemp(){
        viewTemp("createListTemp", cont); 
    }
   
    function addListToDb(){
        
        let token = localStorage.getItem("token");
        let request = {
            method: "POST",
            body: JSON.stringify({
                listName: get("nameInp").value,
                userId: dataUserId,
                auth: token,
                active: 1,
                whatToDo: "new list"
            }),
            headers: {
                "Content-Type": "application/json; charset=utf-8"
            }
        };
        
        console.log("sender liste til db"); 
        
        fetch('/app/list/',request).then(data => {
            if(data.status < 400){
                return data.json();                
            }
            
        }).then(json => {
            localStorage.setItem("listId",json.listId);
        }).catch(err =>{
            console.error(err);
        }); 
        console.log(dataUserId + dataUserName);
        
        get("listNameCont").innerHTML += `<p class="ptag">Lista: <span style="color:#f76f6f;">${get("nameInp").value}</span> er opprettet </p>`;
        //get("nameInp").value = "";
        
        let btn = document.createElement("button");
        btn.appendChild(document.createTextNode("Endre"));
        btn.classList.add("buttons");
        btn.onclick = displayEditLis;
        get("listNameCont").appendChild(btn);
        
        localStorage.setItem("current listName",get("nameInp").value);
    }
    
    get("userTxt").innerHTML += dataUserName;

/*----------------- add post to list ------------------- */
    
    function displayEditLis(){
        viewTemp("addPostToList", cont);
        let currentName = localStorage.getItem("current listName")
        get("listNameHeader").innerHTML += `<h3>${currentName}</h3>`
    }
    
    function addPostsToDb(){
        
        let token = localStorage.getItem("token");
        let request = {
                method: "POST",
                body: JSON.stringify({
                    listPost: get("elemInp").value,
                    listId: localStorage.getItem("listId"),
                    check: 0,
                    active: 1,
                    auth: token,
                    whatToDo: "new post"
                }),
                headers: {
                    "Content-Type": "application/json; charset=utf-8"
                }
            };
            console.log("sender liste til db"); 

            fetch('/app/post',request).then(data => {
                if(data.status < 400){
                    return data.json();
                }
            }).then(json => {
                localStorage.setItem("postId",json.postId);
            }).catch(err =>{
                console.error(err);
            }); 
        
        let arrayPost= [];
        arrayPost.push(get("elemInp").value);
        get("contCreateList").innerHTML = "";
        
        for(let i = 0; i < arrayPost.length; i++){
            get("contCreateList").innerHTML += `
                <ul class="ul-list"><li class="bullets">${arrayPost[i]} <button id="btn" onclick="duedate()">duedate</button></li></ul>
            `;  
        }
        console.log(arrayPost);
    }
    
    function duedate(){
        console.log("tid");
        let dateInp = document.createElement("input");
        dateInp.setAttribute("type", "date");
        get("contCreateList").appendChild(dateInp);
    }
    
/*----------------- Show all lists ------------------- */
    let listData;
    let postData;
    let curListId;
    
    console.log(dataUserId)
    //let username = localStorage.getItem("userName");

    function displayShowListTemp(){
        viewTemp("showListTemp", cont);
        showListsFromDb();
        showPostsFromDb();
        //showUnCheckFromDb();
    }
    
    async function showListsFromDb() {
        let token = localStorage.getItem("token");
        
        let cfg = {
            method: "GET",            
            headers: {
                "Content-Type": "application/json; charset=utf-8",
                "x-access-auth": token
            }
        }   //// fetch(`/app/user/${username}`).then(data => {     
        try { 
            let response = await fetch('/app/list/?token=' + dataUserId, cfg);
            listData = await response.json();
            console.log(listData); 
            refresh();
            
        } catch (err) {
            console.log(err);
        }
    }
    
    async function showPostsFromDb() {
        let token = localStorage.getItem("token");
        
        let cfg = {
            method: "GET",            
            headers: {
                "Content-Type": "application/json; charset=utf-8",
                "x-access-auth": token
            }
        }
        try { 
            let response = await fetch(`/app/post/`, cfg);
            postData = await response.json();
            console.log(postData); 
            
        } catch (err) {
            console.log(err);
        }
    }
    
    let listActive;
    function active(){
        listActive =  listData.filter(function(name) {
            return name.active == 1; 
        }); 
        console.log(listActive)
    }
    
    function refresh(){
        get("contLister").innerHTML = "";
        for (let i = 0; i < listData.length; i++) {
            get("contLister").innerHTML += `
                <h2 style="color: #f76f6f;">${listData[i].list_name}</h2>
                <p> id: ${listData[i].list_id}</p>
                <div>
                    <img id="btnEditList" onclick="showOne(${i})" src="../img/new-list-icon.png" class="small-icons">
                    <img id="delListBtn" onclick="deleteList(${i})" src="../img/delete-icon.png" class="small-icons">
                </div>
                <hr>
            `;
            get("btnEditList").id = listData[i].list_id;
            get("delListBtn").id = listData[i].list_id;
        }         
    }
    
/*----------------- Delete lists ------------------- */  
    
    function deleteList(evt){
        let selectedListId = event.currentTarget.id; 
        console.log(selectedListId);
      
        let ok = confirm("Vil du slette?");
        if (ok == true) {
            console.log("You pressed OK!");
            x();
        } else {
            console.log("You pressed Cancel!");
        }

        function x(){
            let token = localStorage.getItem("token");
            let request = {
                method: "POST",
                headers: {
                    "Content-Type": "application/json; charset=utf-8",
                    "x-access-auth": token
                },
                body:JSON.stringify({
                    delListId: selectedListId
                })
            };
            console.log("oppdatert liste til db"); 

            fetch('/app/list/delete',request).then(data => {
                if(data.status < 400){
                    return data.json();
                    console.log("ferdig oppdatert");
                    //displayShowListTemp();                    
                }
            }).catch(err =>{
                console.error(err);
            });
        }
    }
    
/*----------------- Show one lists ------------------- */  
   
    async function showOne(evt){   
        
     
        selectedListId = event.currentTarget.id;
     
        let filterName =  listData.filter(function(name) {
            return name.list_id == selectedListId;
        });
        
        let filterPost =  postData.filter(function(post) {
            return post.list_id == selectedListId;
        });
        
        console.log(filterPost);
        console.log("klikk liste id " + selectedListId + " navn: " + filterName[0].list_name);
        get("contLister").innerHTML ="";
        
        for (let i=0; i < filterPost.length ; i++){
            get("titleTxt").innerHTML = filterName[0].list_name;
            get("contLister").innerHTML += ` 
                <button id="donePost" onclick="checkPost()">V</button>
                <lable for="donePost"> ${filterPost[i].post}</label>
                <img id="delPostBtn" onclick="deletePost()" src="../img/delete-icon.png" class="small-icons"><br>
            `;
                
            get("donePost").id = filterPost[i].post_id;
            get("delPostBtn").id = filterPost[i].post_id;     

        }
        
        let inp = document.createElement("INPUT");
        let btn = document.createElement("BUTTON");
        let txt = document.createTextNode("Legg til");
        
        get("contLister").appendChild(inp); 
        btn.appendChild(txt);
        get("contLister").appendChild(btn); 
        
        get("contLister").innerHTML += `<br><br> <button id="doneEdit" class="buttons">Ferdig!</button>`;
        
         let title = document.createElement("h3");
        let txt2 = document.createTextNode("Ferdig!");
        title.appendChild(txt2);
        get("contDone").appendChild(title);
        //get("doneEdit").onclick = checkToDb;*/
    }
    
 /*----------------- check to done ------------------- */  
   
    //contDone
    function checkPost(evt){
        selectedPostId = event.currentTarget.id;
        let filterDone =  postData.filter(function(done) {
            return done.post_id == selectedPostId;
        });
        console.log(filterDone);
        
       
                
        for (let i=0; i < filterDone.length ; i++){
            get("contDone").innerHTML += `
                <lable> ${filterDone[i].post}</label><br>
            `;
        }
        
    }
    
/*----------------- Delete Posts ------------------- */ 
    
   function deletePost(evt){
        let selectedPostId = event.currentTarget.id; 
        console.log(selectedListId);
        
        let token = localStorage.getItem("token");
        let request = {
                method: "POST",
                headers: {
                    "Content-Type": "application/json; charset=utf-8",
                    "x-access-auth": token
                },
                body:JSON.stringify({
                    delListId: selectedPostId
                })
            };
            console.log("oppdatert liste til db"); 

            fetch('/app/post/delete',request).then(data => {
                if(data.status < 400){
                    return data.json();
                    console.log("ferdig oppdatert");
                    //displayShowListTemp();                    
                }
            }).catch(err =>{
                console.error(err);
            });        
    } 
    
    
/*----------------- Profile-modal ------------------- */   

    function openModal1() {
        get("profileModal").style.display = "block";
    }
    
    function closeModal() {
        get("profileModal").style.display = "none";
    }
    
    window.onclick = function(event) {
        if (event.target == get("profileModal")) {
            get("profileModal").style.display = "none";
        }
    }
    
/*----------------- logg ut modal ------------------- */   

    function openModal2() {
        get("logoutModal").style.display = "block";
    }
    
    function logout(){
        window.location = "index.html";
        //logger faktisk ikke ut
    }

/*----------------- -------------- ------------------- */   
    
    function viewTemp(id, cont) {
        cont.innerHTML = "";
        let templ = document.getElementById(id);
        let clone = templ.content.cloneNode(true);         
        cont.appendChild(clone);
    }
    
    function get(id) {
        return document.getElementById(id);
    }
        
</script>
    
</html>